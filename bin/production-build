#!/bin/sh

set -e

package="$1"

if [ -z "$package" ]; then
  echo "Usage: $0 <package name>"
  exit 1
fi

command -v docker >/dev/null

IMAGE_NAME="coconutestate/cargo"
docker build . --tag $IMAGE_NAME
docker run --rm --interactive --tty \
  --volume "$(pwd):/code" \
  --volume "$(pwd)/.docker-cache/registry:/root/.cargo/registry" \
  --volume "$(pwd)/.docker-cache/target:/code/target" \
  --workdir /code \
  $IMAGE_NAME cargo build --release --target=x86_64-unknown-linux-gnu --package "$package"

echo "==> Binary created at:"
echo ".docker-cache/target/x86_64-unknown-linux-gnu/release/$package"
sudo chown -R $(id -un):$(id -gn) .docker-cache
