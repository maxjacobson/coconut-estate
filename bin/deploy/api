#!/usr/bin/env ruby

require "open-uri"
require "json"

def system!(cmd)
  system(cmd) or raise
end

system! "bin/prod/build api"

droplets_json = `doctl compute droplet list --tag-name api --output json`
raise unless $?.success?

JSON.parse(droplets_json).each do |droplet|
  ip = droplet.fetch("networks").fetch("v4").detect { |network| network.fetch("type") == "public" }.fetch("ip_address")

  system! "bin/scp deploy-artifacts/api #{ip}:/mnt/api/binary/api-new"
  system! "bin/ssh #{ip} sudo systemctl stop api.service"
  system! "bin/ssh #{ip} mv /mnt/api/binary/api-new /mnt/api/binary/api"
  system! "bin/ssh #{ip} sudo systemctl restart api.service"
end
